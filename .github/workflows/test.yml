name: Tests

on:
  push:
    branches: [ main, master, develop, codec ]
  pull_request:
    branches: [ main, master, develop, codec ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-git-

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-build-target-

    # - name: Download and install kdb+
    #   run: |
    #     # Download kdb+ (free 64-bit version for Linux)
    #     mkdir -p $HOME/q
    #     cd $HOME/q
    #     wget -q https://github.com/KxSystems/kdb/releases/download/v4.1t-2024.08.16/linux-x64.zip
    #     unzip -q linux-x64.zip
    #     chmod +x q/l64/q
        
    #     # Add to PATH
    #     echo "$HOME/q/q/l64" >> $GITHUB_PATH
        
    #     # Create password file for authentication
    #     mkdir -p $HOME/.kdb
    #     # Generate SHA1 hash for password "pass" for user "kdbuser"
    #     # kdbuser:pass -> kdbuser:9d4e1e23bd5b727046a9e3b4b7db57bd8d6ee684
    #     echo "kdbuser:9d4e1e23bd5b727046a9e3b4b7db57bd8d6ee684" > $HOME/.kdb/passwd

    # - name: Start kdb+ server
    #   run: |
    #     cd $HOME/q/q
    #     # Start q on port 5000 in the background with authentication
    #     nohup ./l64/q -p 5000 -u $HOME/.kdb/passwd > q.log 2>&1 &
    #     echo $! > q.pid
        
    #     # Wait for q to be ready
    #     sleep 5
        
    #     # Check if q is running
    #     if ! kill -0 $(cat q.pid) 2>/dev/null; then
    #       echo "Failed to start q"
    #       cat q.log
    #       exit 1
    #     fi
        
    #     echo "kdb+ server started on port 5000"

    - name: Run unit tests (kdb_codec)
      run: cargo test --package kdb_codec --lib --tests --verbose
      env:
        RUST_BACKTRACE: 1

    
    # Uncomment the following section to run integration tests that require kdb+
    # - name: Run kdb+ integration tests
    #   run: cargo test --package kdb_codec --tests -- --ignored --nocapture
    #   env:
    #     RUST_BACKTRACE: 1

    # - name: Stop kdb+ server
    #   if: always()
    #   run: |
    #     if [ -f $HOME/q/q/q.pid ]; then
    #       kill $(cat $HOME/q/q/q.pid) || true
    #     fi
